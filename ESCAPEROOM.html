<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escape Room: El Búnker Interactivo</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap');

        body {
            background-color: #1a1a1a;
            color: #a2fca2;
            font-family: 'Roboto Mono', monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        #game-wrapper {
            position: relative;
            width: 100%;
            max-width: 1200px;
            height: 80vh;
            background-color: rgba(0, 0, 0, 0.85);
            border: 2px solid #3c3c3c;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
            overflow: hidden;
        }

        #background-image-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://www.nintendo.com/eu/media/images/06_screenshots/games_5/nintendo_switch_download_software_2/nswitchds_veredaescaperoomadventure/NSwitchDS_VeredaEscapeRoomAdventure_05.jpg');
            background-size: cover;
            background-position: center;
            z-index: 1;
        }

        h1 {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #50fa7b;
            text-shadow: 0 0 5px #0f0;
            z-index: 10;
            background-color: rgba(0,0,0,0.7);
            padding: 5px 15px;
            border-radius: 5px;
            border: 1px solid #50fa7b;
        }

        .hotspot-button {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(80, 250, 123, 0.5);
            border-radius: 5px;
            cursor: pointer;
            z-index: 5;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .hotspot-button:hover { background-color: rgba(80, 250, 123, 0.3); border-color: #50fa7b; }
        .hotspot-button:disabled { cursor: not-allowed; background-color: rgba(255, 255, 255, 0.05); border-color: rgba(80, 250, 123, 0.2); }

        #hotspot-q0 { top: 75%; left: 15%; width: 20%; height: 15%; }
        #hotspot-q1 { top: 25%; left: 30%; width: 10%; height: 20%; }
        #hotspot-q2 { top: 60%; left: 45%; width: 15%; height: 20%; }
        #hotspot-q3 { top: 30%; left: 55%; width: 10%; height: 25%; }
        #hotspot-q4 { top: 35%; left: 80%; width: 15%; height: 30%; }

        #puzzle-overlay { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 650px; background-color: rgba(0, 0, 0, 0.95); border: 2px solid #50fa7b; border-radius: 10px; padding: 25px; box-shadow: 0 0 30px rgba(0, 255, 0, 0.4); z-index: 100; text-align: center; }
        #puzzle-overlay h2 { color: #50fa7b; margin-top: 0; border-bottom: 1px solid #50fa7b; padding-bottom: 10px; margin-bottom: 20px; }
        #puzzle-overlay p { font-size: 1.1em; line-height: 1.6; margin-bottom: 20px; }
        
        #standard-puzzle-controls input[type="text"] { width: 60%; padding: 10px; background-color: #282a36; border: 1px solid #6272a4; color: #f8f8f2; font-family: 'Roboto Mono', monospace; font-size: 1em; border-radius: 4px; }
        #standard-puzzle-controls button { padding: 10px 20px; background-color: #50fa7b; color: #282a36; border: none; font-weight: bold; cursor: pointer; font-family: 'Roboto Mono', monospace; font-size: 1em; border-radius: 4px; margin-left: 10px; }
        
        #close-puzzle-button { background-color: #ff5555; color: white; margin-top: 15px; }
        #puzzle-feedback { margin-top: 10px; font-weight: bold; min-height: 20px; }
        
        #global-message-area { position: absolute; bottom: 0; left: 0; width: 100%; background-color: rgba(0, 0, 0, 0.9); padding: 15px; text-align: center; font-size: 1.2em; color: #50fa7b; border-top: 1px solid #50fa7b; box-sizing: border-box; z-index: 50; display: none; }
        #global-message-area.active { display: block; }

        /* --- Estilos del Klotski Interactivo --- */
        #klotski-container { display: none; margin-top: 15px; }
        #klotski-board {
            position: relative;
            width: 200px; /* 4 unidades de 50px */
            height: 250px; /* 5 unidades de 50px */
            background-color: #333;
            border: 2px solid #6272a4;
            margin: 0 auto;
        }
        .klotski-block {
            position: absolute;
            background-color: #97C2FC;
            border: 1px solid #2B7CE9;
            box-sizing: border-box;
            cursor: grab;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: #111;
        }
        .klotski-block.main-block {
            background-color: #ff5555; /* Pieza principal roja */
            border-color: #D7263D;
        }
        .klotski-block.dragging {
            z-index: 200;
            opacity: 0.7;
            cursor: grabbing;
        }
    </style>
</head>
<body>
    <div id="game-wrapper">
        <div id="background-image-container">
            <button class="hotspot-button" id="hotspot-q0"></button>
            <button class="hotspot-button" id="hotspot-q1"></button>
            <button class="hotspot-button" id="hotspot-q2"></button>
            <button class="hotspot-button" id="hotspot-q3"></button>
            <button class="hotspot-button" id="hotspot-q4"></button>
        </div>

        <h1>El Escape Interactivo</h1>

        <div id="puzzle-overlay">
            <h2 id="overlay-puzzle-title"></h2>
            <p id="overlay-puzzle-text"></p>
            
            <div id="klotski-container">
                <div id="klotski-board"></div>
            </div>

            <div id="standard-puzzle-controls">
                <input type="text" id="overlay-user-input" placeholder="Tu respuesta...">
                <button id="overlay-submit-button">Resolver</button>
            </div>

            <p id="puzzle-feedback"></p>
            <button id="close-puzzle-button">Cerrar</button>
        </div>

        <div id="global-message-area"></div>
    </div>

    <script>
        // --- MOTOR DEL JUEGO (DE auxiliaresPlantilla.js) ---
        function crearAutomata(definicion) { return { ...definicion, estadoActual: definicion.estadoInicial }; }
        function procesarEntrada(automata, entrada) {
            const transicionesEstadoActual = automata.transiciones[automata.estadoActual];
            const entradaNormalizada = entrada.toString().trim().toLowerCase();
            if (transicionesEstadoActual && transicionesEstadoActual[entradaNormalizada]) {
                automata.estadoActual = transicionesEstadoActual[entradaNormalizada];
                return true;
            }
            return false;
        }
        function obtenerEstadoActual(automata) { return automata.estadoActual; }
        function obtenerPreguntaActual(automata) { return automata.contenido[automata.estadoActual] || null; }
        function esEstadoFinal(automata) { return automata.estadosFinales.includes(automata.estadoActual); }
        
        // --- MOTOR DEL JUEGO KLOTSKI (NUEVO CÓDIGO) ---
        const klotskiEngine = {
            unitSize: 50, // 50px por unidad
            board: null,
            blocks: [],
            activeBlock: null,
            offsetX: 0,
            offsetY: 0,
            init: function(containerId, layout, onSolveCallback) {
                this.board = document.getElementById(containerId);
                this.board.innerHTML = ''; // Limpiar tablero anterior
                this.blocks = layout.map(blockData => this.createBlock(blockData));
                this.onSolve = onSolveCallback;
                this.board.addEventListener('mousemove', e => this.drag(e));
                window.addEventListener('mouseup', e => this.endDrag(e));
            },
            createBlock: function(data) {
                const block = document.createElement('div');
                block.className = 'klotski-block';
                block.dataset.id = data.id;
                block.style.width = `${data.w * this.unitSize}px`;
                block.style.height = `${data.h * this.unitSize}px`;
                block.style.left = `${data.x * this.unitSize}px`;
                block.style.top = `${data.y * this.unitSize}px`;
                if (data.id === 1) block.classList.add('main-block');
                block.addEventListener('mousedown', e => this.startDrag(e, block));
                this.board.appendChild(block);
                return { id: data.id, x: data.x, y: data.y, w: data.w, h: data.h, element: block };
            },
            startDrag: function(e, blockElement) {
                this.activeBlock = this.blocks.find(b => b.element === blockElement);
                this.activeBlock.element.classList.add('dragging');
                const rect = blockElement.getBoundingClientRect();
                this.offsetX = e.clientX - rect.left;
                this.offsetY = e.clientY - rect.top;
            },
            drag: function(e) {
                if (!this.activeBlock) return;
                e.preventDefault();
                const boardRect = this.board.getBoundingClientRect();
                let newX = e.clientX - boardRect.left - this.offsetX;
                let newY = e.clientY - boardRect.top - this.offsetY;

                // Restringir movimiento a un solo eje
                const deltaX = Math.abs(newX - (this.activeBlock.x * this.unitSize));
                const deltaY = Math.abs(newY - (this.activeBlock.y * this.unitSize));

                if (deltaX > deltaY) newY = this.activeBlock.y * this.unitSize;
                else newX = this.activeBlock.x * this.unitSize;

                // Limitar al tablero
                newX = Math.max(0, Math.min(newX, this.board.clientWidth - this.activeBlock.element.clientWidth));
                newY = Math.max(0, Math.min(newY, this.board.clientHeight - this.activeBlock.element.clientHeight));
                
                this.activeBlock.element.style.left = `${newX}px`;
                this.activeBlock.element.style.top = `${newY}px`;
            },
            endDrag: function(e) {
                if (!this.activeBlock) return;
                const oldGridX = this.activeBlock.x;
                const oldGridY = this.activeBlock.y;
                let newGridX = Math.round(this.activeBlock.element.offsetLeft / this.unitSize);
                let newGridY = Math.round(this.activeBlock.element.offsetTop / this.unitSize);

                // Validar colisión
                let collision = false;
                for (const block of this.blocks) {
                    if (block === this.activeBlock) continue;
                    if (newGridX < block.x + block.w && newGridX + this.activeBlock.w > block.x &&
                        newGridY < block.y + block.h && newGridY + this.activeBlock.h > block.y) {
                        collision = true;
                        break;
                    }
                }
                
                if (collision) {
                    this.activeBlock.element.style.left = `${oldGridX * this.unitSize}px`;
                    this.activeBlock.element.style.top = `${oldGridY * this.unitSize}px`;
                } else {
                    this.activeBlock.x = newGridX;
                    this.activeBlock.y = newGridY;
                    this.activeBlock.element.style.left = `${newGridX * this.unitSize}px`;
                    this.activeBlock.element.style.top = `${newGridY * this.unitSize}px`;
                }
                
                this.activeBlock.element.classList.remove('dragging');
                this.activeBlock = null;
                this.checkWin();
            },
            checkWin: function() {
                const mainBlock = this.blocks.find(b => b.id === 1);
                // Condición de victoria: bloque principal en x=1, y=3
                if (mainBlock.x === 1 && mainBlock.y === 3) {
                    this.onSolve();
                }
            }
        };

        // --- LÓGICA DEL JUEGO ESCAPE ROOM ---
        document.addEventListener('DOMContentLoaded', () => {
            const puzzleOverlay = document.getElementById('puzzle-overlay');
            const overlayPuzzleTitle = document.getElementById('overlay-puzzle-title');
            const overlayPuzzleText = document.getElementById('overlay-puzzle-text');
            const klotskiContainer = document.getElementById('klotski-container');
            const standardPuzzleControls = document.getElementById('standard-puzzle-controls');
            const overlayUserInput = document.getElementById('overlay-user-input');
            const overlaySubmitButton = document.getElementById('overlay-submit-button');
            const puzzleFeedback = document.getElementById('puzzle-feedback');
            const closePuzzleButton = document.getElementById('close-puzzle-button');
            const globalMessageArea = document.getElementById('global-message-area');
            const allHotspots = document.querySelectorAll('.hotspot-button');
            
            const definicionAutomata = {
                estados: ['q0', 'q1', 'q2', 'q3', 'q4', 'q5', 'q6'],
                estadoInicial: 'q0',
                estadosFinales: ['q6'],
                transiciones: {
                    'q0': { '4': 'q1' }, 'q1': { '15': 'q2' }, 'q2': { '7': 'q3' },
                    'q3': { '8': 'q4' }, 'q4': { 'resuelto': 'q5' }, 'q5': { '5310': 'q6' }
                },
                contenido: {
                    'q0': { title: "Puzle 1: Observación", text: "Estás en una habitación... Para empezar, ¿Cuántas sillas hay?", hotspotId: 'hotspot-q0' },
                    'q1': { title: "Puzle 2: Secuencia", text: "¡Correcto! En la pizarra hay una secuencia: 1, 3, 6, 10, ... ¿Cuál es el siguiente?", hotspotId: 'hotspot-q1' },
                    'q2': { title: "Puzle 3: Adivinanza", text: "¡Excelente! Una nota dice: 'Blanco por dentro, verde por fuera...' ¿Cuántas letras tiene la respuesta?", hotspotId: 'hotspot-q2' },
                    'q3': { title: "Puzle 4: Sistema Solar", text: "¡Asombroso! En un libro... ¿Cuántos planetas hay en el sistema solar?", hotspotId: 'hotspot-q3' },
                    'q4': { title: "Puzle 5: El Klotski", text: "La cerradura de la puerta es un puzle Klotski. Mueve el bloque rojo a la salida inferior.", isKlotski: true, hotspotId: 'hotspot-q4' },
                    'q5': { title: "Puzle Final: Código de Escape", text: "Al resolver el Klotski, se revela un código: 5310. ¡Introdúcelo!", hotspotId: 'hotspot-q4' },
                    'q6': { title: "¡HAS ESCAPADO!", text: "🎉 ¡Felicidades! La puerta se abre. ¡Has escapado! 🎉" }
                },
                klotskiLayout: [ // Datos de tu Klotski.json
                    {"id": 1, "x": 1, "y": 0, "w": 2, "h": 2},
                    {"id": 2, "x": 0, "y": 0, "w": 1, "h": 2},
                    {"id": 3, "x": 3, "y": 0, "w": 1, "h": 2},
                    {"id": 4, "x": 0, "y": 2, "w": 1, "h": 2},
                    {"id": 5, "x": 3, "y": 2, "w": 1, "h": 2},
                    {"id": 6, "x": 1, "y": 2, "w": 2, "h": 1},
                    {"id": 7, "x": 1, "y": 3, "w": 1, "h": 1},
                    {"id": 8, "x": 2, "y": 3, "w": 1, "h": 1}
                ]
            };

            const miJuego = crearAutomata(definicionAutomata);

            function updateHotspots() {
                const contenido = obtenerPreguntaActual(miJuego);
                allHotspots.forEach(hotspot => {
                    hotspot.disabled = true;
                    hotspot.style.opacity = '0.2';
                });
                if (contenido && contenido.hotspotId) {
                    const activeHotspot = document.getElementById(contenido.hotspotId);
                    if (activeHotspot) {
                        activeHotspot.disabled = false;
                        activeHotspot.style.opacity = '1';
                    }
                }
            }

            function showPuzzleOverlay() {
                const content = obtenerPreguntaActual(miJuego);
                if (!content) return;
                overlayPuzzleTitle.innerText = content.title;
                overlayPuzzleText.innerText = content.text;
                overlayUserInput.value = '';
                puzzleFeedback.innerText = '';
                
                klotskiContainer.style.display = 'none';
                standardPuzzleControls.style.display = 'none';

                if (content.isKlotski) {
                    klotskiContainer.style.display = 'block';
                    klotskiEngine.init('klotski-board', miJuego.klotskiLayout, () => {
                        // Esta función se llama al ganar
                        handleAnswerSubmission('resuelto');
                    });
                } else {
                    standardPuzzleControls.style.display = 'block';
                    overlayUserInput.focus();
                }
                
                puzzleOverlay.style.display = 'block';
            }

            function handleAnswerSubmission(answer) {
                const esCorrecto = procesarEntrada(miJuego, answer);
                if (esCorrecto) {
                    puzzleFeedback.innerText = ">> ¡Correcto! Se ha desbloqueado algo nuevo. <<";
                    puzzleFeedback.style.color = '#50fa7b';
                    setTimeout(() => {
                        puzzleOverlay.style.display = 'none';
                        updateGameStatus();
                    }, 500); // Pequeño delay para ver el feedback
                } else {
                    puzzleFeedback.innerText = ">> No parece ser la respuesta correcta. Intenta de nuevo. <<";
                    puzzleFeedback.style.color = '#ff5555';
                }
            }

            function updateGameStatus() {
                updateHotspots();
                if (esEstadoFinal(miJuego)) {
                    const content = obtenerPreguntaActual(miJuego);
                    globalMessageArea.innerHTML = content.text;
                    globalMessageArea.classList.add('active');
                    allHotspots.forEach(hotspot => hotspot.disabled = true);
                }
            }

            allHotspots.forEach(hotspot => {
                hotspot.addEventListener('click', () => !hotspot.disabled && showPuzzleOverlay());
            });

            closePuzzleButton.addEventListener('click', () => puzzleOverlay.style.display = 'none');
            overlaySubmitButton.addEventListener('click', () => handleAnswerSubmission(overlayUserInput.value));
            overlayUserInput.addEventListener('keyup', e => e.key === 'Enter' && handleAnswerSubmission(overlayUserInput.value));

            updateGameStatus();
            globalMessageArea.innerText = "Busca pistas en la habitación para escapar.";
            globalMessageArea.classList.add('active');
            setTimeout(() => globalMessageArea.classList.remove('active'), 3000);
        });
    </script>
</body>
</html>